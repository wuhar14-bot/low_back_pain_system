import React from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { User, RotateCcw, CheckCircle2 } from "lucide-react";

export default function PainAreaSection({ formData, updateFormData }) {
  const handleAreaToggle = (areaKey) => {
    const currentAreas = formData.pain_areas || {};
    const newAreas = {
      ...currentAreas,
      [areaKey]: !currentAreas[areaKey]
    };
    updateFormData({ pain_areas: newAreas });
  };

  const clearAllSelections = () => {
    updateFormData({ pain_areas: {} });
  };

  const confirmAreas = () => {
    const selectedAreas = formData.pain_areas || {};
    const selectedCount = Object.values(selectedAreas).filter(Boolean).length;
    if (selectedCount > 0) {
      alert(`已确认选择 ${selectedCount} 个疼痛区域`);
    } else {
      alert('请先选择疼痛区域');
    }
  };

  const getSelectedCount = () => {
    const selected = formData.pain_areas || {};
    return Object.values(selected).filter(Boolean).length;
  };

  const getSelectedAreas = () => {
    const selected = formData.pain_areas || {};
    return painAreas.filter(area => selected[area.key]);
  };

  // CHOIR Body Map - 38 Posterior Regions
  // Based on Stanford CHOIR Body Map (Scherrer et al., PLOS Computational Biology, 2022)
  const painAreas = [
    // Head regions
    { key: 'head_top_left', label: '头顶左侧', path: 'M189 4.99999V32.5L187.34 33.84C183.89 34.94 160.93 31.42 156.48 30.03C155.18 29.62 154.89 30.8 154.97 28.51C155.04 26.36 155.93 25.1 156.82 23.33C163.2 10.66 174.6 3.98999 189 5.00999V4.99999Z' },
    { key: 'head_top_right', label: '头顶右侧', path: 'M191 5.00001C203.35 2.42001 223.57 15.79 224.03 28.49C224.11 30.8 223.85 29.63 222.49 29.98C212.87 32.49 200.96 33.45 191 34V5.00001Z' },
    { key: 'head_back_left', label: '后脑左侧', path: 'M188 88H171.5C168.43 88 166.9 84.59 165.19 82.31C154.4 67.96 150.99 48.58 154.01 31C157.32 32.06 161.18 33.41 164.6 33.9C171.23 34.84 180.71 33.94 186.5 35C187.62 35.21 188.37 35.51 189 36.5V85.5C189 85.83 187.68 87.02 188 88Z' },
    { key: 'head_back_right', label: '后脑右侧', path: 'M191 88L190.52 36.95C191.23 35.82 192.23 35.26 193.53 35.03C199.16 34.02 208.03 34.73 214.37 33.88C218 33.39 221.85 32.93 224.98 31.01C227.08 42.11 226.28 53.72 223.01 64.52C221.12 70.75 213.74 88.01 206.5 88.01H191V88Z' },

    // Neck regions
    { key: 'neck_left', label: '颈部左侧', path: 'M189 90V115C184.39 115.24 179.49 113.09 175.33 111.17C163.32 105.65 168.03 107.22 168.94 96.34C169.14 93.94 167.02 90.79 168.98 89.46L189 90Z' },
    { key: 'neck_right', label: '颈部右侧', path: 'M210.99 89L211.54 105.98C204.99 110.01 197.94 114.57 190 115L191.14 90.15C197.39 88.12 204.19 91.54 210.99 89Z' },

    // Shoulder regions
    { key: 'shoulder_left', label: '左肩', path: 'M146.62 157.64C136.79 170.65 119.87 186.49 102.45 185.04C92.59 184.22 93.43 180.35 94.01 171.52C95 156.36 101.33 134.36 116.76 128.27C121.48 126.4 126 126.9 130.25 125.76C136.92 123.98 146.66 119.62 152.88 116.39C156.69 114.41 161.31 110.1 164.33 108.75C165.3 108.32 165.66 107.85 166.54 108.92C170 112.08 165.17 123.74 163.5 128C159.74 137.54 152.82 149.47 146.63 157.65L146.62 157.64Z' },
    { key: 'shoulder_right', label: '右肩', path: 'M272.41 135.59C280.66 144.63 284.37 159.4 284.98 171.51C285.25 176.92 286.49 184.14 279.54 185.05C248.61 189.11 221.24 145.75 212.95 120.53C212.38 118.78 209.8 110.53 210.05 109.62C211.39 104.78 220.08 112.95 222.32 114.17C227.55 117.03 234.45 120.52 240.01 122.48C252.63 126.94 262.83 125.11 272.4 135.59H272.41Z' },

    // Upper back regions
    { key: 'upper_back_left', label: '上背部左侧', path: 'M188.87 118.13L187.78 188.79C185.06 189.44 182.36 189.88 179.54 190.05C171.08 190.55 158.96 189.98 150.5 189C146.67 188.55 126.09 184.81 123.98 183.52C122.31 182.5 126 179.71 126.39 179.4C128.62 177.66 131.7 176.17 134.2 173.95C151.37 158.74 165.9 134.79 170 112L188.86 118.14L188.87 118.13Z' },
    { key: 'upper_back_right', label: '上背部右侧', path: 'M209 111C212.88 136.29 229.83 161.94 249.5 178.01C250.5 178.82 257.84 181.88 255.02 183.53C234.84 188.22 211.81 192.89 191.44 188.07L191.13 118.64L209 111.01V111Z' },

    // Upper arm regions
    { key: 'upper_arm_left', label: '左上臂', path: 'M117.99 240C108.94 231.89 98.81 229.65 88.01 236L95 186C100.04 187.06 105.23 187.37 110.39 186.9C112.9 186.67 118.1 183.77 119.52 185.97L125 209.48L117.98 240H117.99Z' },
    { key: 'upper_arm_right', label: '右上臂', path: 'M285 186L291 236C280 231.58 269.81 231.13 261.02 240C260.36 231.46 254.01 218.48 254.01 210.5C254.01 203.39 259.24 192.53 260.09 185.08C268.61 186.96 276.27 187.91 285 186Z' },

    // Mid back regions
    { key: 'mid_back_left', label: '中背部左侧', path: 'M189 191V270C182.23 271.08 140.08 267.87 137.41 264.03C138.49 237.61 127.06 212.2 121.99 186.51C122.05 185.55 123.51 185.98 124.39 186.09C135.61 187.51 148.11 191.18 159.52 191.97C168.92 192.63 179.73 192.18 189 190.99V191Z' },
    { key: 'mid_back_right', label: '中背部右侧', path: 'M191 270V191C208.1 193.63 225.27 191.38 242.21 188.71C246.78 187.99 251.6 186.95 255.98 185.47C257.38 185 257.06 184.51 257.03 186.52C256.82 198.42 247.14 222.48 244.48 235.98C242.61 245.48 241.82 254.36 241.54 264.04C225.46 269.68 207.94 270.35 191 270Z' },

    // Elbow regions
    { key: 'elbow_left', label: '左肘', path: 'M113.87 256.86C107.43 258.56 102.54 260.88 95.59 259.91C92.53 259.48 81.48 256.1 82.01 252.63C82.15 251.74 87.55 239.13 88.03 238.54C92.13 233.46 106.28 234.52 111.7 237.8C119.81 242.71 113.61 249.19 113.86 256.87L113.87 256.86Z' },
    { key: 'elbow_right', label: '右肘', path: 'M274.76 235.26C278.66 234.76 288.09 236.01 290.99 238.51C291.79 239.2 297.47 253.57 296.56 255.01C295.48 256.72 284.97 259.75 282.49 259.99C275.57 260.64 266.34 259.66 264.28 252.22C261.43 241.93 263.49 236.7 274.76 235.26Z' },

    // Forearm regions
    { key: 'forearm_left', label: '左前臂', path: 'M113.99 259C111.28 281.12 98.77 299.37 89.99 319H88.51C83.48 313.18 74.43 311.58 66.99 311.99L80 256C90.69 262.76 102.23 263.96 113.98 259H113.99Z' },
    { key: 'forearm_right', label: '右前臂', path: 'M312 312L299.22 313.73L289.99 318.52C279.21 299.56 268.68 280.85 265 259.01C276.79 262.78 288.47 263.41 298.98 256L312 312Z' },

    // Lower back regions
    { key: 'lower_back_left', label: '下背部左侧', path: 'M189 312C176.57 311.34 156.73 310.53 146.51 302.99C141.15 299.04 138.58 291.77 129.99 291.48L137.01 266.99L187.32 272.96C187.98 273.16 189.01 275.22 189.01 275.49V311.99L189 312Z' },
    { key: 'lower_back_right', label: '下背部右侧', path: 'M191 273C207.93 272.75 224.85 270.63 241.38 267.07L249.03 291.47C240.45 291.93 238.15 299.61 233.53 303.03C223.99 310.1 202.66 311.42 191 312V273Z' },

    // Wrist regions
    { key: 'wrist_left', label: '左腕', path: 'M76.75 342.74C74.92 344.51 70.52 344.25 68.24 343.25C67.04 342.72 58.81 334.35 58.39 333.02C57.29 329.5 60.58 327.38 61.87 324.38C62.9 321.99 64.61 314.67 66.65 314.11C74.43 315.29 82.58 314.32 87.72 321.49C84.21 326 80.16 339.45 76.75 342.75V342.74Z' },
    { key: 'wrist_right', label: '右腕', path: 'M302.21 341.77C300.9 341.01 291.72 322.36 292.14 320.71C293.21 316.46 308.9 313 312.33 314.14C313.69 314.59 319.97 329.68 319.6 331.03C316.71 335.61 308.13 345.18 302.21 341.77Z' },

    // Hip regions
    { key: 'hip_left', label: '左髋', path: 'M117 374C117.22 350.87 120.95 327.42 126.46 304.96C127.18 302.03 127.89 298.08 128.9 295.4C129.32 294.3 128.31 293.72 130.46 294.01C136.94 294.88 142.66 301.47 145.47 307.02C158.43 332.59 146.22 368.09 116.99 374H117Z' },
    { key: 'hip_right', label: '右髋', path: 'M249.9 294.1C256.05 320.3 262.68 346.86 261.99 374.01C233.46 367.93 221.82 332.35 233.8 307.32C236.44 301.79 243.19 293.38 249.89 294.11L249.9 294.1Z' },

    // Buttocks regions
    { key: 'buttocks_left', label: '左臀', path: 'M184.75 380.75C164.85 393.14 141.21 383.79 121 376.99C126.49 372.47 133.22 370.1 138.53 365.03C153.22 350.99 156.78 325.12 148 307.01C148.71 306.44 157.56 310.39 159.61 310.89C169.09 313.22 178.98 313.31 188.57 314.93C188.65 336.92 191.62 359.6 184.75 380.75Z' },
    { key: 'buttocks_right', label: '右臀', path: 'M230.99 307C223.14 326.57 226.13 348.12 240.07 364.19C245.37 370.3 252.03 372.23 257.99 376.98C237.71 384.01 214.37 392.71 194.25 380.73C187.85 359.61 193.06 337.14 190.11 315.57C190.75 312.87 198.88 314.3 201.48 313.98C211.57 312.71 221.45 310.4 230.99 307Z' },

    // Hand regions
    { key: 'hand_left', label: '左手', path: 'M55.9 332.07C58.23 336.86 64.37 344.71 69.74 345.78C72.41 346.31 77.46 344.51 77.96 346.6C78.36 348.3 74.81 365.86 73.78 368.27C70.84 375.13 69.69 378.57 67.29 385.78C66.21 389.02 64.4 395.66 61 396.49C62.55 391.38 63.35 386.01 64.29 380.76C64.45 379.86 65.5 376.89 63.51 377.01C61.36 377.15 54.85 399.02 51.32 400.85L44.01 400.99L49 373C47.01 372.62 46.58 373.9 45.92 375.41C43.68 380.57 43.91 389.06 41.22 394.71C40.71 395.78 39.3 398.18 37.99 396.48L43 349C37.87 349.89 34.54 355.37 29.71 357.2C28.42 357.69 23.33 358.27 24.01 355.51C34.21 350.45 38.14 339.94 48.33 334.82C49.46 334.25 55.45 331.76 55.9 332.07Z' },
    { key: 'hand_right', label: '右手', path: 'M338.43 340.58C342.24 343.77 344.82 347.83 348.5 351C350.65 352.85 355.08 353.35 355 356.99C347.28 358.6 342.56 351.51 336.01 349L341 396.99C338.79 397.73 337.37 393.18 336.82 391.68C334.58 385.53 335.26 377.68 331.02 373C329.63 382.77 335.9 391.35 335 401C332.05 397.46 330.35 401.52 327.6 401.08C326.34 400.88 317.69 380.97 317 378.01C315.65 376.63 315.12 378.11 314.98 379.52C314.57 383.58 317.4 390.98 317.94 395.6C318.17 397.57 317.76 397.04 316.03 397C312.57 389.33 311.08 380.92 308.52 373C307.64 370.28 305.54 368.14 304.5 365.02C302.26 358.28 302.4 350.91 301.02 344.01C310.05 347.52 317.18 338.63 321.67 331.93C328.33 333.26 333.5 336.45 338.44 340.58H338.43Z' },

    // Thigh regions
    { key: 'thigh_left', label: '左大腿', path: 'M184.99 384C184.95 397.72 181.67 411.94 180.95 425.45C180.03 442.9 182.05 460.57 179.99 477.99C170.09 473.39 159.87 470.48 148.74 472.24C144.37 472.93 141.08 475.94 137 476.99C136.66 464.54 131.17 453.08 128.28 441.21C123.19 420.27 118.8 398.59 118 377C138.01 387.3 163.61 394.22 184.98 384H184.99Z' },
    { key: 'thigh_right', label: '右大腿', path: 'M260.99 378C260.57 412.08 248.22 444.03 241.99 476.99C241.55 477.38 233.37 472.62 231.26 472.23C221.12 470.35 207.41 473.12 199 478.99C197.49 447.27 198.63 415.51 194 384C194.53 383.44 205.93 388.56 208.58 388.91C225.74 391.17 245.24 384.09 260.99 378Z' },

    // Knee regions
    { key: 'knee_left', label: '左膝', path: 'M179.86 481.14L173.8 518.3L172.56 520.06C160.4 525.56 146.86 523.01 136.07 515.86C138.62 503.78 137.79 491.43 138.16 479.15C151.58 470.16 166.63 473.91 179.85 481.13L179.86 481.14Z' },
    { key: 'knee_right', label: '右膝', path: 'M239.74 478.25C242.1 480.71 240.66 492.46 240.95 496.54C241.19 499.85 243.71 514.19 242.77 515.79C232.37 523.92 217.85 525.39 205.96 519.52L200.12 490.37C199.42 482.46 198.1 480.75 206.01 477.52C212.79 474.75 223.02 473 230.25 474.24C231.75 474.5 238.93 477.42 239.73 478.25H239.74Z' },

    // Calf regions
    { key: 'calf_left', label: '左小腿', path: 'M173.99 522C174.06 535.8 177.66 548.66 177.04 562.54C176.47 575.28 172.82 588.08 173.99 600.99C165.33 598.76 154.91 599.85 147.49 604.97C146.8 604.98 144.45 596.93 144.04 595.44C138.79 576.11 133.12 554.54 133.95 534.45C134.05 532.14 135.34 518.49 136 517.99C146.61 526.05 161.89 527.34 173.98 521.99L173.99 522Z' },
    { key: 'calf_right', label: '右小腿', path: 'M243.99 518.01C244.2 527.86 245.54 537.65 245.04 547.55C244.1 566.17 236.83 585.87 232.49 604.01L217.48 600.03L206 601.01C205.87 583.81 200.72 565.61 202.01 548.53C202.66 539.86 206.27 531.06 205 522.02C215.82 526.02 226.52 526.55 237.23 521.75C238.57 521.15 243.27 517.2 243.99 518.02V518.01Z' },

    // Ankle regions
    { key: 'ankle_left', label: '左踝', path: 'M172.9 603.1L175.01 626.48C174.42 632.96 156.55 631.64 152.17 628.82L148.08 606.06C156.53 604.05 164.13 599.37 172.9 603.09V603.1Z' },
    { key: 'ankle_right', label: '右踝', path: 'M230.88 606.11L226 629.51C222.23 632 204.33 632.44 204.07 626.58C203.92 623.14 205.66 616.35 205.98 612.5C206.23 609.39 205.68 606.22 206.11 603.12C214.66 598.99 222.5 603.79 230.87 606.11H230.88Z' },

    // Foot regions
    { key: 'foot_left', label: '左足', path: 'M170.5 633C171.51 632.86 175.05 630.3 175.99 631C180.71 640.21 175.68 648.83 175.94 657.51C176.08 662.42 181.33 674.18 177.43 676.93C172.92 680.11 168.61 676.47 164.54 675.97C159.95 675.41 153.93 676.79 149.55 675.96C147.07 675.49 145.13 672.49 142.01 672.99C140.95 671.82 146.77 666.87 147.83 665.32C149.39 663.04 152.89 657.26 153.34 654.78C153.88 651.81 151.94 650.12 151.96 647.47C151.99 643.94 155.81 637.94 154.01 633C159.21 632.5 165.48 633.69 170.51 633H170.5Z' },
    { key: 'foot_right', label: '右足', path: 'M225 633C223.48 637.83 226.72 642.85 226.97 646.61C227.17 649.57 225.53 651.73 226.2 655.25C226.49 656.8 230.47 664.43 231.57 665.93C233.09 667.99 238.75 670.9 237 672.98C236.71 673.33 229.13 675.83 228.44 675.94C223.88 676.67 218.3 675.5 213.55 676.05C210.24 676.43 202.38 681.51 201.03 674.47C199.97 668.97 203.28 661.98 203.05 655.45C202.75 647.07 198.74 639.73 203.04 631.01C204.96 630.04 207.96 632.99 208.51 632.99H225.01L225 633Z' }
  ];

  return (
    <div className="space-y-6">
      {/* Instructions */}
      <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
        <h3 className="text-lg font-semibold text-blue-800 mb-2">疼痛区域选择</h3>
        <p className="text-sm text-blue-700 mb-2">
          请根据患者描述，在下方人体后视图中点击疼痛或不适的区域
        </p>
        <ul className="text-xs text-blue-600 space-y-1">
          <li>• 白色区域：正常无疼痛</li>
          <li>• 红色区域：有疼痛或不适</li>
          <li>• 点击区域可切换选择状态</li>
        </ul>
      </div>

      <Card className="border border-slate-200">
        <CardHeader className="pb-4">
          <CardTitle className="text-lg text-slate-800 flex items-center gap-2">
            <User className="w-5 h-5" />
            后视疼痛区域选择 (CHOIR Body Map)
            {getSelectedCount() > 0 && (
              <Badge variant="destructive" className="ml-2">
                已选择 {getSelectedCount()} 个区域
              </Badge>
            )}
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-6">
            {/* SVG Body Diagram - CHOIR Body Map */}
            <div className="flex justify-center">
              <div className="relative">
                <svg
                  width="387"
                  height="693"
                  viewBox="0 0 387 693"
                  className="border border-slate-200 rounded-lg bg-slate-100"
                >
                  {/* Clickable anatomical regions */}
                  {painAreas.map((area) => {
                    const isSelected = (formData.pain_areas || {})[area.key];

                    return (
                      <path
                        key={area.key}
                        d={area.path}
                        fill={isSelected ? '#EF4444' : 'white'}
                        stroke={isSelected ? '#DC2626' : '#9CA3AF'}
                        strokeWidth="1"
                        className="cursor-pointer transition-all duration-200 hover:opacity-70"
                        onClick={() => handleAreaToggle(area.key)}
                      >
                        <title>{area.label}</title>
                      </path>
                    );
                  })}
                </svg>

                {/* Label */}
                <div className="text-center mt-4">
                  <h4 className="text-sm font-semibold text-slate-700">后视疼痛选择</h4>
                  <h5 className="text-xs text-slate-500">(CHOIR Body Map - 38区域)</h5>
                </div>
              </div>
            </div>

            {/* Action buttons */}
            <div className="flex justify-center gap-4">
              <Button
                variant="outline"
                onClick={clearAllSelections}
                className="border-blue-200 text-blue-600 hover:bg-blue-50"
                disabled={getSelectedCount() === 0}
              >
                <RotateCcw className="w-4 h-4 mr-2" />
                清除选择
              </Button>
              <Button
                onClick={confirmAreas}
                className="bg-green-600 hover:bg-green-700 text-white"
                disabled={getSelectedCount() === 0}
              >
                <CheckCircle2 className="w-4 h-4 mr-2" />
                确认区域
              </Button>
            </div>

            {/* Selected areas list */}
            {getSelectedCount() > 0 && (
              <div className="space-y-2">
                <h4 className="text-sm font-medium text-slate-700">已选择的疼痛区域：</h4>
                <div className="flex flex-wrap gap-2">
                  {getSelectedAreas().map((area) => (
                    <Badge
                      key={area.key}
                      variant="destructive"
                      className="cursor-pointer hover:bg-red-600"
                      onClick={() => handleAreaToggle(area.key)}
                    >
                      {area.label}
                      <span className="ml-1 text-xs">×</span>
                    </Badge>
                  ))}
                </div>
                <p className="text-xs text-slate-500">
                  点击标签可取消选择
                </p>
              </div>
            )}

            {/* Legend */}
            <div className="flex justify-center gap-6 text-sm">
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-red-500 rounded border border-red-600"></div>
                <span className="text-slate-700">疼痛区域</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-white rounded border border-gray-400"></div>
                <span className="text-slate-700">无疼痛</span>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
